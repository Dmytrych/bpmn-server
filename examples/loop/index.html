<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Multi-instance Tasks (loops): - bpmn-server</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Multi-instance Tasks (loops):";
        var mkdocs_page_input_path = "examples\\loop.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> bpmn-server
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Overview</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../invokation/">Invoking Workflows</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../execution/">Execution</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../scripting/">Scripting</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../security/">Security</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../data/">Data</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../">Examples</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../api-summary/">API Summary</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../api/readme/">API</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../setup/">Setup</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../customization/">Application Integration</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">bpmn-server</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Multi-instance Tasks (loops):</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="multi-instance-tasks-loops">Multi-instance Tasks (loops):<a class="headerlink" href="#multi-instance-tasks-loops" title="Permanent link">#</a></h1>
<p>Any Task can have multi-instance either Sequential or Parrallel</p>
<p>Loops have a unique data structure to support multiple items for same node with each of unique data</p>
<p>We will use an example to illustrate the use of loops:
- We would like to conduct a poll on various departments about new projects coming up
- We will retrieve department list from a DB using <code>Get Department List</code> service task
- For each department will initiate a subProcess <code>department</code> with a multi-instance</p>
<h2 id="defining-loop-collection">Defining loop collection<a class="headerlink" href="#defining-loop-collection" title="Permanent link">#</a></h2>
<ul>
<li>Input Collection is defined as an Array, defines the multipicity of the node.</li>
<li>Each value in the collection becomes a key to item</li>
</ul>
<p><img alt="Design" src="../loop-design.png" /></p>
<ul>
<li>Since we like to have various departments vote at any time, we make the multi-instance <code>parallel</code></li>
<li>Inside the subprocess instance will assign users and designate more information about the vote in <code>Prepare for a vote</code></li>
<li>A User Task <code>vote</code> to allow desigated users/user groups to vote with some input fields</li>
<li>After all department complete their vote, another task <code>Summarize Votes</code> will process the results</li>
</ul>
<p><img alt="Design" src="../loop-inst.png" /></p>
<h2 id="data-structure">Data structure<a class="headerlink" href="#data-structure" title="Permanent link">#</a></h2>
<ul>
<li>Each loop instance stores its own unique data elements, for subProcess loops data is shared among all node items inside the subprocess</li>
</ul>
<p>So the data structure looks like:</p>
<blockquote>
<p>Loop name</p>
<blockquote>
<p>Key</p>
<blockquote>
<p>data</p>
</blockquote>
</blockquote>
</blockquote>
<pre><code class="language-js">department: {
    IT: {
      scriptLog: 'added by script event,key:IT',
      votedBy: 'IT-User',
      vote: 85
    },
    HR: {
      scriptLog: 'added by script event,key:HR',
      votedBy: 'HR-User',
      vote: 100
    },
    Billing: {
      scriptLog: 'added by script event,key:Billing',
      votedBy: 'Billing-User',
      vote: 80
    }
  }
</code></pre>
<p>Any node inside the loop will share same data, so inside 'HR' </p>
<pre><code class="language-js">  console.log(item.data.vote,'for ',item.itemKey);
</code></pre>
<p>Will produce: <code>100 for HR</code>.</p>
<p>However, <code>Summarize Votes</code> task is outside the subprocess and at the root, so it has the instance data structure
So once you have access to instance data:</p>
<pre><code class="language-ts">  Object.keys(item.data.department).forEach(key=&gt;{
    console.log('Vote for:',key,item.data.department[key]['vote']);

  });
</code></pre>
<p>will produce:</p>
<pre><code>Vote for: IT 100
Vote for: HR 85
Vote for: Billing 80
</code></pre>
<h2 id="data-search">Data Search<a class="headerlink" href="#data-search" title="Permanent link">#</a></h2>
<ul>
<li>During the execution, either through an event or a script/service task</li>
</ul>
<pre><code class="language-ts">    item.token.execution.getItems().filter(itm=&gt;(itm.elementId=='Activity_vote')).forEach(voteItem=&gt;{

        let vote =voteItem['data']['vote'];
        let dept=voteItem.itemKey;

        console.log(&quot;vote Item&quot;,voteItem.seq,'dept:',dept,'vote',vote);

    });
</code></pre>
<ul>
<li>In a detached fashion, like a batch job or remote access </li>
</ul>
<pre><code class="language-ts">    let items=await api.data.findItems({&quot;items.elementId&quot;:'Activity_vote',&quot;data.caseId&quot;:1050});
    items.forEach(voteItem=&gt;{

        let vote =voteItem['data']['vote'];
        let dept=voteItem.itemKey;

        console.log(&quot;vote Item&quot;,voteItem.seq,'dept:',dept,'vote',vote);

    });
</code></pre>
<ul>
<li>Search for a particular item by key:</li>
</ul>
<pre><code class="language-json">    let items=await api.data.findItems({&quot;items.elementId&quot;:'Activity_vote',&quot;items.itemKey&quot;:&quot;HR&quot;});
</code></pre>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
